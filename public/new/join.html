<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Join Community - Life Swap</title>
  <!-- Google Fonts: Poppins for a clean, modern feel -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2); /* Soft cyan gradient */
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal {
      position: relative;
      background: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      font-size: 28px;
      font-weight: 600;
      color: #0277bd;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    h2 .material-icons {
      font-size: 32px;
      color: #0288d1;
    }

    #communityLocation {
      font-size: 16px;
      color: #555;
      margin: 0 0 20px;
      font-weight: 300;
    }

    a {
      display: inline-flex;
      align-items: center;
      padding: 12px 25px;
      background: #0288d1;
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 400;
      transition: background 0.3s, transform 0.2s;
    }

    a:hover:not(.disabled) {
      background: #0277bd;
      transform: translateY(-2px);
    }

    a.disabled {
      background: #b0bec5;
      pointer-events: none;
      cursor: not-allowed;
    }

    a .material-icons {
      margin-right: 8px;
    }

    .login-msg {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
      font-weight: 300;
    }

    .login-msg a {
      background: none;
      color: #0288d1;
      padding: 0;
      font-weight: 400;
    }

    .login-msg a:hover {
      color: #0277bd;
      text-decoration: underline;
      transform: none;
    }

    #errorMsg {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 15px;
      font-weight: 300;
    }

    /* SVG Background Accent */
    .modal::before {
      content: '';
      position: absolute;
      top: -50px;
      left: -50px;
      width: 150px;
      height: 150px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50 10 C70 10 90 30 90 50 C90 70 70 90 50 90 C30 90 10 70 10 50 C10 30 30 10 50 10 Z" fill="none" stroke="%230288d1" stroke-width="4" opacity="0.2"/></svg>') no-repeat;
      z-index: -1;
    }

    .modal::after {
      content: '';
      position: absolute;
      bottom: -30px;
      right: -30px;
      width: 100px;
      height: 100px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="%230277bd" stroke-width="3" opacity="0.3"/></svg>') no-repeat;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div id="joinModal" class="modal">
    <h2 id="communityName">
      <span class="material-icons">group</span>
      Loading...
    </h2>
    <p id="communityLocation"></p>
    <a id="joinLink" href="#" class="disabled">
      <span class="material-icons">login</span>
      Join Now
    </a>
    <p id="errorMsg"></p>
    <p id="authMsg" class="login-msg"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB5Q0kHoViWJl-t-pWCKj_AT-ClAMadfrU",
      authDomain: "life-swap-6065e.firebaseapp.com",
      projectId: "life-swap-6065e",
      storageBucket: "life-swap-6065e.firebasestorage.app",
      messagingSenderId: "475311181000",
      appId: "1:475311181000:web:32d03d80f70081bfb629fd",
      measurementId: "G-CHJY2ZEYYF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Smart cache with expiration (24 hours)
    const locationCache = new Map();
    const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

    async function getLocationName(lat, lon) {
      const cacheKey = `loc_${lat}_${lon}`;
      const cached = locationCache.get(cacheKey);

      if (cached && (Date.now() - cached.timestamp < CACHE_EXPIRY)) {
        return cached.value;
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`, {
          headers: { "User-Agent": "LifeSwap/1.0 (your-email@example.com)" }
        });
        const data = await response.json();
        const city = data.address?.city || data.address?.town || data.address?.village || "";
        const region = data.address?.state || data.address?.county || data.address?.country || "";
        const locationName = city && region ? `${city}, ${region}` : data.display_name || "Unknown Location";

        locationCache.set(cacheKey, { value: locationName, timestamp: Date.now() });
        return locationName;
      } catch (error) {
        console.error("Reverse geocoding failed:", error);
        return "Unknown Location";
      }
    }

    // Get community ID from URL
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const joinLink = document.getElementById("joinLink");
    const authMsg = document.getElementById("authMsg");

    if (!id) {
      document.getElementById("errorMsg").textContent = "No community ID provided.";
    } else {
      onAuthStateChanged(auth, async (user) => {
        const commRef = doc(db, "communities", id);
        try {
          const docSnap = await getDoc(commRef);
          if (!docSnap.exists()) {
            throw new Error("Community not found!");
          }
          const data = docSnap.data();
          const locationName = await getLocationName(data.location.latitude, data.location.longitude);

          document.getElementById("communityName").textContent = `Join ${data.name}`;
          document.getElementById("communityLocation").textContent = locationName;

          if (user) {
            joinLink.classList.remove("disabled");
            joinLink.href = `./community.html?id=${id}`;
            authMsg.textContent = "";
          } else {
            joinLink.classList.add("disabled");
            joinLink.href = "#";
            authMsg.innerHTML = 'To join communities, please create an account here: <a href="/login.html">Login</a>';
          }
        } catch (error) {
          console.error("Fetch failed:", error);
          document.getElementById("errorMsg").textContent = "An error occurred. Please check the console.";
        }
      });
    }
  </script>
</body>
</html>